<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kırgızistan Projesi Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .drag-over {
            background-color: #e5e7eb;
        }
        .dragging {
            opacity: 0.5;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
            <span class="text-gray-700">Veriler yükleniyor...</span>
        </div>
    </div>

    <div id="app">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Kırgızistan Projesi Dashboard</h1>
                        <p class="text-sm text-gray-600">Proje Yönetim Sistemi</p>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div id="connectionStatus" class="flex items-center text-sm">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-green-600">Bağlı</span>
                        </div>
                        
                        <button id="refreshBtn" class="p-2 text-gray-400 hover:text-gray-600">
                            <i data-lucide="refresh-cw"></i>
                        </button>
                        
                        <button id="notificationBtn" class="p-2 text-gray-400 hover:text-gray-600 relative">
                            <i data-lucide="bell"></i>
                            <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </button>
                        
                        <button id="importBtn" class="flex items-center px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i data-lucide="upload" class="mr-2 w-4 h-4"></i>
                            Excel İçe Aktar
                        </button>
                        
                        <button id="exportBtn" class="flex items-center px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i data-lucide="download" class="mr-2 w-4 h-4"></i>
                            Excel Dışa Aktar
                        </button>
                        
                        <button id="addTaskBtn" class="flex items-center px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                            <i data-lucide="plus" class="mr-2 w-4 h-4"></i>
                            Görev Ekle
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex space-x-8 py-3">
                    <button data-view="dashboard" class="nav-btn flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-colors bg-purple-100 text-purple-700">
                        <i data-lucide="bar-chart-3" class="mr-2 w-4 h-4"></i>
                        Panel
                    </button>
                    <button data-view="roadmap" class="nav-btn flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-colors text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <i data-lucide="calendar" class="mr-2 w-4 h-4"></i>
                        Yol Haritası
                    </button>
                    <button data-view="gantt" class="nav-btn flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-colors text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <i data-lucide="clock" class="mr-2 w-4 h-4"></i>
                        Gantt Şeması
                    </button>
                    <button data-view="activities" class="nav-btn flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-colors text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <i data-lucide="activity" class="mr-2 w-4 h-4"></i>
                        Aktiviteler
                    </button>
                </nav>
            </div>
        </div>

        <!-- Filters -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex-1 min-w-[200px]">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="Görevleri ara..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                        </div>
                    </div>
                    
                    <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">Tüm Durumlar</option>
                        <option value="done">Tamamlandı</option>
                        <option value="ongoing">Devam Ediyor</option>
                        <option value="pending">Beklemede</option>
                    </select>
                    
                    <select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">Tüm Kategoriler</option>
                        <option value="sourcing">KAYNAK BULMA</option>
                        <option value="hiring">İŞE ALIM</option>
                        <option value="placement_legal">YERLEŞTİRME VE HUKUK</option>
                    </select>
                    
                    <select id="responsibleFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">Tüm Sorumlu Kişiler</option>
                    </select>
                    
                    <select id="timePhaseFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">Tüm Zaman Dilimleri</option>
                        <option value="30_days">30 Gün</option>
                        <option value="60_days">60 Gün</option>
                        <option value="90_days">90 Gün</option>
                        <option value="end_of_year">Yıl Sonu</option>
                    </select>
                    
                    <button id="clearFiltersBtn" class="px-3 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Filtreleri Temizle
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div id="mainContent" class="space-y-6">
                <!-- Content will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Task Modal (Aynı kalıyor, sadece id'ler değişiyor) -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modalTitle" class="text-lg font-semibold">Yeni Görev Ekle</h3>
                <button id="closeModalBtn">
                    <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Görev Başlığı *</label>
                    <input type="text" id="taskTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                    <textarea id="taskDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" rows="3"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                        <select id="taskCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="sourcing">KAYNAK BULMA</option>
                            <option value="hiring">İŞE ALIM</option>
                            <option value="placement_legal">YERLEŞTİRME VE HUKUK</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Zaman Dilimi</label>
                        <select id="taskTimePhase" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="30_days">30 Gün</option>
                            <option value="60_days">60 Gün</option>
                            <option value="90_days">90 Gün</option>
                            <option value="end_of_year">Yıl Sonu</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Durum</label>
                        <select id="taskStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="pending">Beklemede</option>
                            <option value="ongoing">Devam Ediyor</option>
                            <option value="done">Tamamlandı</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Süre (gün)</label>
                        <input type="number" id="taskDuration" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sorumlu</label>
                    <input type="text" id="taskResponsible" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Sorumlu kişi adı" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Oluşturan</label>
                    <input type="text" id="taskCreatedBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Oluşturan kişi adı" />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Başlangıç Tarihi</label>
                        <input type="date" id="taskStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bitiş Tarihi</label>
                        <input type="date" id="taskEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
                    </div>
                </div>

                <div id="progressContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">İlerleme (<span id="progressValue">0</span>%)</label>
                    <input type="range" id="taskProgress" min="0" max="100" value="0" class="w-full" />
                </div>

                <div class="flex gap-3 pt-4">
                    <button id="saveTaskBtn" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50">
                        <i data-lucide="save" class="inline mr-2 w-4 h-4"></i>
                        <span id="saveTaskBtnText">Kaydet</span>
                    </button>
                    <button id="cancelTaskBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                        İptal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <div class="flex items-center">
            <i data-lucide="alert-circle" class="mr-2 w-4 h-4"></i>
            <span id="errorMessage">Bir hata oluştu</span>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <div class="flex items-center">
            <i data-lucide="check-circle" class="mr-2 w-4 h-4"></i>
            <span id="successMessage">İşlem başarılı</span>
        </div>
    </div>
    <!-- Supabase Configuration -->
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://uxhxcnxvntmoisomsgax.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4aHhjbnh2bnRtb2lzb21zZ2F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4OTUzNzMsImV4cCI6MjA2NzQ3MTM3M30._3gLOhPkBRMitSwEQ7qT582lDg8IgytRwUd_K401xAk';
        console.log('✅ Supabase config yüklendi');
    </script>
    
    <!-- Supabase Client -->
    <script>
        // Supabase client'ı başlat
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // API Fonksiyonları
        class TaskAPI {
            // Tüm görevleri getir
            static async getAllTasks() {
                try {
                    const { data, error } = await supabaseClient
                        .from('tasks')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Görevler alınırken hata:', error);
                    return [];
                }
            }

            // Yeni görev ekle
            static async createTask(taskData) {
                try {
                    const { data, error } = await supabaseClient
                        .from('tasks')
                        .insert([{
                            title: taskData.title,
                            description: taskData.description,
                            category: taskData.category,
                            time_phase: taskData.timePhase,
                            status: taskData.status,
                            responsible: taskData.responsible,
                            created_by: taskData.createdBy,
                            start_date: taskData.startDate,
                            end_date: taskData.endDate,
                            duration: taskData.duration,
                            progress: taskData.progress
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Görev oluşturulurken hata:', error);
                    throw error;
                }
            }

            // Görev durumu güncelle
            static async updateTaskStatus(taskId, newStatus) {
                try {
                    const { data, error } = await supabaseClient
                        .from('tasks')
                        .update({ status: newStatus })
                        .eq('id', taskId)
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Görev durumu güncellenirken hata:', error);
                    throw error;
                }
            }

            // Görev zaman dilimi güncelle
            static async updateTaskTimePhase(taskId, newTimePhase) {
                try {
                    const { data, error } = await supabaseClient
                        .from('tasks')
                        .update({ time_phase: newTimePhase })
                        .eq('id', taskId)
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Görev zaman dilimi güncellenirken hata:', error);
                    throw error;
                }
            }
        }

        console.log('📄 TaskAPI yüklendi');
    </script>

    <!-- Main Application Script -->
    <script>
        // Global state
        let tasks = [];
        let filteredTasks = [];
        let currentView = 'dashboard';
        let searchTerm = '';
        let filters = {
            status: 'all',
            category: 'all',
            responsible: 'all',
            timePhase: 'all'
        };
        let editingTask = null;

        // Sabitler
        const categories = {
            sourcing: { name: 'KAYNAK BULMA', color: '#8b44ad', icon: '🎯' },
            hiring: { name: 'İŞE ALIM', color: '#8b44ad', icon: '👥' },
            placement_legal: { name: 'YERLEŞTİRME VE HUKUK', color: '#8b44ad', icon: '⚖️' }
        };

        const timePhases = {
            '30_days': { name: '30 Gün', color: '#d8b7db' },
            '60_days': { name: '60 Gün', color: '#b488b7' },
            '90_days': { name: '90 Gün', color: '#9058a0' },
            'end_of_year': { name: 'Yıl Sonu', color: '#8b44ad' }
        };

        const statusConfig = {
            done: { name: 'Tamamlandı', color: 'text-green-600', bgColor: 'bg-green-100 text-green-800' },
            ongoing: { name: 'Devam Ediyor', color: 'text-yellow-600', bgColor: 'bg-yellow-100 text-yellow-800' },
            pending: { name: 'Beklemede', color: 'text-gray-600', bgColor: 'bg-gray-100 text-gray-800' }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                console.log('🚀 Uygulama başlatılıyor...');
                
                // Icons'ları yükle
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
                // Event listener'ları başlat
                initializeEventListeners();
                
                // Verileri yükle
                await loadTasks();
                
                // Loading overlay'ı gizle
                hideLoading();
                
                console.log('✅ Uygulama başarıyla başlatıldı');
            } catch (error) {
                console.error('❌ Uygulama başlatma hatası:', error);
                hideLoading();
            }
        }

        async function loadTasks() {
            try {
                showLoading();
                console.log('📊 Görevler yükleniyor...');
                
                tasks = await TaskAPI.getAllTasks();
                console.log('✅ Görevler yüklendi:', tasks.length, 'görev');
                
                // Supabase'den gelen verileri uygun formata çevir
                tasks = tasks.map(task => ({
                    id: task.id,
                    title: task.title,
                    description: task.description || '',
                    category: task.category,
                    timePhase: task.time_phase,
                    status: task.status,
                    responsible: task.responsible || '',
                    createdBy: task.created_by || '',
                    startDate: task.start_date || '',
                    endDate: task.end_date || '',
                    duration: task.duration || 0,
                    progress: task.progress || 0
                }));
                
                updateFilteredTasks();
                updateResponsibleFilter();
                renderContent();
            } catch (error) {
                console.error('❌ Görevler yüklenirken hata:', error);
            } finally {
                hideLoading();
            }
        }

        function initializeEventListeners() {
            console.log('🎯 Event listener\'lar başlatılıyor...');
            
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentView = e.currentTarget.dataset.view;
                    updateNavigation();
                    renderContent();
                });
            });

            // Add Task Button
            const addTaskBtn = document.getElementById('addTaskBtn');
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', () => {
                    openTaskModal();
                });
            }

            // Modal events
            const closeModalBtn = document.getElementById('closeModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    closeTaskModal();
                });
            }

            const cancelTaskBtn = document.getElementById('cancelTaskBtn');
            if (cancelTaskBtn) {
                cancelTaskBtn.addEventListener('click', () => {
                    closeTaskModal();
                });
            }
        }

        // Utility functions
        function showLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        function updateFilteredTasks() {
            filteredTasks = tasks.filter(task => {
                const matchesSearch = task.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    task.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    task.responsible.toLowerCase().includes(searchTerm.toLowerCase());
                
                const matchesStatus = filters.status === 'all' || task.status === filters.status;
                const matchesCategory = filters.category === 'all' || task.category === filters.category;
                const matchesResponsible = filters.responsible === 'all' || task.responsible.includes(filters.responsible);
                const matchesTimePhase = filters.timePhase === 'all' || task.timePhase === filters.timePhase;

                return matchesSearch && matchesStatus && matchesCategory && matchesResponsible && matchesTimePhase;
            });
        }

        function updateNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.view === currentView) {
                    btn.className = 'nav-btn flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-colors bg-purple-100 text-purple-700';
                } else {
                    btn.className = 'nav-btn flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-colors text-gray-500 hover:text-gray-700 hover:bg-gray-100';
                }
            });
        }

        function updateResponsibleFilter() {
            const responsibleFilter = document.getElementById('responsibleFilter');
            if (!responsibleFilter) return;
            
            const uniqueResponsibles = [...new Set(tasks.flatMap(task => 
                task.responsible.split(', ').map(r => r.trim()).filter(r => r)
            ))].sort();

            const currentValue = responsibleFilter.value;
            responsibleFilter.innerHTML = '<option value="all">Tüm Sorumlu Kişiler</option>';
            uniqueResponsibles.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                responsibleFilter.appendChild(option);
            });
            responsibleFilter.value = currentValue;
        }

      function renderContent() {
    const mainContent = document.getElementById('mainContent');
    if (!mainContent) return;
    
    switch(currentView) {
        case 'dashboard':
            mainContent.innerHTML = renderDashboardView();
            break;
        case 'roadmap':
            mainContent.innerHTML = renderRoadmapView();
            initializeRoadmapEvents();
            break;
        case 'gantt':
            mainContent.innerHTML = renderGanttView();
            break;
        case 'activities':
            mainContent.innerHTML = renderActivitiesView();
            break;
        default:
            mainContent.innerHTML = '<div class="bg-white rounded-lg p-8 text-center"><h3 class="text-lg font-semibold text-gray-900">Bu görünüm henüz hazırlanıyor...</h3></div>';
    }
    
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

        function renderDashboardView() {
            const progress = calculateProgress();
            
            return `
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-purple-50 border border-purple-200 p-6 rounded-lg shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <i data-lucide="bar-chart-3" class="h-6 w-6 text-purple-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-purple-600">Toplam Görev</p>
                                <p class="text-2xl font-semibold text-purple-900">${filteredTasks.length}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-purple-50 border border-purple-200 p-6 rounded-lg shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <i data-lucide="check-circle" class="h-6 w-6 text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-purple-600">Tamamlanan</p>
                                <p class="text-2xl font-semibold text-purple-900">${filteredTasks.filter(task => task.status === 'done').length}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-purple-50 border border-purple-200 p-6 rounded-lg shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100">
                                <i data-lucide="alert-circle" class="h-6 w-6 text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-purple-600">Devam Eden</p>
                                <p class="text-2xl font-semibold text-purple-900">${filteredTasks.filter(task => task.status === 'ongoing').length}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-purple-50 border border-purple-200 p-6 rounded-lg shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-gray-100">
                                <i data-lucide="clock" class="h-6 w-6 text-gray-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-purple-600">Bekleyen</p>
                                <p class="text-2xl font-semibold text-purple-900">${filteredTasks.filter(task => task.status === 'pending').length}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="bg-purple-50 border border-purple-200 p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-purple-900">Son Aktiviteler</h3>
                    <div class="space-y-3">
                        ${filteredTasks
                            .slice(0, 5)
                            .map(task => `
                                <div class="flex items-center space-x-3">
                                    <div class="w-2 h-2 rounded-full ${task.status === 'done' ? 'bg-green-500' : task.status === 'ongoing' ? 'bg-yellow-500' : 'bg-gray-500'}"></div>
                                    <span class="text-sm text-purple-800 font-medium">${task.title}</span>
                                    <span class="text-xs text-purple-600">- ${task.responsible}</span>
                                </div>
                            `).join('')}
                    </div>
                </div>
            `;
        }

        function calculateProgress() {
            const totalTasks = tasks.length;
            const doneTasks = tasks.filter(task => task.status === 'done').length;
            const ongoingTasks = tasks.filter(task => task.status === 'ongoing').length;
            const pendingTasks = tasks.filter(task => task.status === 'pending').length;

            return {
                total: totalTasks,
                done: doneTasks,
                ongoing: ongoingTasks,
                pending: pendingTasks,
                donePercentage: totalTasks > 0 ? (doneTasks / totalTasks) * 100 : 0,
                ongoingPercentage: totalTasks > 0 ? (ongoingTasks / totalTasks) * 100 : 0
            };
        }

        // Modal functions
        function openTaskModal(task = null) {
            const modal = document.getElementById('taskModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeTaskModal() {
            const modal = document.getElementById('taskModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        console.log('📄 app.js yüklendi');
    </script>
    // ROADMAP VİEW FONKSİYONU
        function renderRoadmapView() {
            const categoryEntries = Object.entries(categories);
            
            return `
                <div class="bg-white rounded-lg overflow-hidden shadow-lg">
                    <!-- Header -->
                    <div class="grid grid-cols-5 gap-0">
                        <div class="bg-gradient-to-r from-purple-600 to-purple-800 text-white font-bold text-center py-2 text-sm">
                            GİRİŞİM
                        </div>
                        ${Object.entries(timePhases).map(([key, phase]) => `
                            <div class="text-white font-bold text-center py-2 text-xs" style="background-color: ${phase.color}">
                                ${phase.name}
                            </div>
                        `).join('')}
                    </div>

                    <!-- Content -->
                    ${categoryEntries.map(([catKey, category], categoryIndex) => `
                        ${categoryIndex > 0 ? '<div class="h-1 bg-gray-100"></div>' : ''}
                        <div class="grid grid-cols-5 gap-0">
                            <!-- Category Header -->
                            <div class="text-white font-bold flex items-center justify-center p-1.5 text-center min-h-[150px]" style="background-color: ${category.color}">
                                <div>
                                    <div class="text-base mb-1">${category.icon}</div>
                                    <div class="text-base font-bold leading-tight">${category.name}</div>
                                </div>
                            </div>
                            
                            <!-- Category Cells -->
                            ${Object.keys(timePhases).map(phaseKey => `
                                <div class="drop-zone p-1 border-r border-b border-gray-200 bg-gray-50 min-h-[150px]" 
                                     data-category="${catKey}" 
                                     data-phase="${phaseKey}">
                                    ${filteredTasks
                                        .filter(task => task.category === catKey && task.timePhase === phaseKey)
                                        .map(task => renderRoadmapTaskCard(task))
                                        .join('')}
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ROADMAP TASK CARD FONKSİYONU
        function renderRoadmapTaskCard(task) {
            const shortTitle = task.title.length > 45 ? task.title.substring(0, 42) + '...' : task.title;
            const shortDesc = task.description.length > 35 ? task.description.substring(0, 32) + '...' : task.description;
            
            return `
                <div class="task-card rounded bg-purple-50 border border-purple-200 p-1.5 mb-1.5 shadow-sm hover:shadow-md transition-all duration-200 cursor-move"
                     data-task-id="${task.id}"
                     draggable="true">
                    <div class="flex items-start justify-between mb-1.5">
                        <h4 class="font-bold text-[9px] text-purple-900 leading-tight flex-1 pr-1 break-words">${shortTitle}</h4>
                        <button class="edit-task-btn p-0.5 hover:bg-purple-200 rounded flex-shrink-0" data-task-id="${task.id}">
                            <i data-lucide="edit-2" class="w-2.5 h-2.5 text-purple-600"></i>
                        </button>
                    </div>
                    
                    <p class="text-[8px] text-purple-700 mb-1.5 leading-tight font-medium break-words">${shortDesc}</p>
                    
                    <div class="flex items-center justify-between text-[7px]">
                        <span class="text-purple-800 font-bold truncate flex-1 pr-1">${task.responsible}</span>
                        <div class="flex gap-0.5 flex-shrink-0">
                            ${['pending', 'ongoing', 'done'].map(status => `
                                <button class="status-btn w-2 h-2 rounded-full border transition-colors ${
                                    task.status === status 
                                        ? (status === 'done' ? 'bg-green-500 border-green-600' :
                                           status === 'ongoing' ? 'bg-yellow-500 border-yellow-600' :
                                           'bg-red-500 border-red-600')
                                        : 'border-gray-400 hover:border-gray-600'
                                }" 
                                data-task-id="${task.id}" 
                                data-status="${status}" 
                                title="${statusConfig[status].name}"></button>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${task.status === 'ongoing' ? `
                        <div class="mt-1.5">
                            <div class="w-full bg-purple-200 rounded-full h-0.5">
                                <div class="bg-purple-600 h-0.5 rounded-full transition-all duration-300" style="width: ${task.progress}%"></div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // GANTT VİEW FONKSİYONU
        function renderGanttView() {
            const today = new Date();
            const startDate = new Date('2025-04-01');
            const endDate = new Date('2026-02-01');
            
            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold">Gantt Şeması Görünümü</h3>
                        <p class="text-sm text-gray-600">Görevlerin zaman çizelgesi</p>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <div class="min-w-[1200px]">
                            <!-- Timeline Header -->
                            <div class="flex border-b border-gray-200">
                                <div class="w-80 p-3 font-semibold bg-gray-50">Görev</div>
                                <div class="flex-1 p-3 bg-gray-50">
                                    <div class="flex justify-between text-sm text-gray-600">
                                        <span>Nis 2025</span>
                                        <span>Tem 2025</span>
                                        <span>Eki 2025</span>
                                        <span>Oca 2026</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Tasks -->
                            ${filteredTasks.map(task => {
                                const position = getTaskPosition(task, startDate, endDate);
                                return `
                                    <div class="flex border-b border-gray-100 hover:bg-gray-50">
                                        <div class="w-80 p-3">
                                            <div class="font-medium text-sm">${task.title}</div>
                                            <div class="text-xs text-gray-500">${task.responsible}</div>
                                            <div class="text-xs text-purple-600">${categories[task.category].name}</div>
                                        </div>
                                        <div class="flex-1 p-3 relative">
                                            <div class="absolute top-2 h-6 rounded ${
                                                task.status === 'done' ? 'bg-green-500' :
                                                task.status === 'ongoing' ? 'bg-yellow-500' :
                                                'bg-gray-400'
                                            }" style="left: ${position.left}; width: ${position.width}">
                                                <div class="px-2 text-xs text-white leading-6 truncate">
                                                    ${task.title}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // AKTİVİTELER VİEW FONKSİYONU
        function renderActivitiesView() {
            const today = new Date();
            const thisWeekActivities = getThisWeekActivities();
            const completedTasks = thisWeekActivities.filter(activity => activity.type === 'completed');
            const startedTasks = thisWeekActivities.filter(activity => activity.type === 'started');
            const progressTasks = thisWeekActivities.filter(activity => activity.type === 'progress');
            
            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white rounded-lg shadow-lg p-6 border border-purple-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-purple-900">Bu Hafta Aktiviteler</h2>
                                <p class="text-sm text-purple-600 mt-1">EXCO Sunumu İçin Haftalık İlerleme Raporu</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-purple-600">Rapor Tarihi</p>
                                <p class="text-lg font-semibold text-purple-900">${today.toLocaleDateString('tr-TR')}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-6 shadow-lg">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-600">
                                    <i data-lucide="check-circle" class="h-6 w-6 text-white"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-purple-700">Tamamlanan Görevler</p>
                                    <p class="text-3xl font-bold text-purple-900">${completedTasks.length}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-6 shadow-lg">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-600">
                                    <i data-lucide="play-circle" class="h-6 w-6 text-white"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-purple-700">Başlanan Görevler</p>
                                    <p class="text-3xl font-bold text-purple-900">${startedTasks.length}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-6 shadow-lg">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-600">
                                    <i data-lucide="trending-up" class="h-6 w-6 text-white"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-purple-700">İlerleme Kaydeden</p>
                                    <p class="text-3xl font-bold text-purple-900">${progressTasks.length}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Activities -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Completed Tasks -->
                        <div class="bg-white rounded-lg shadow-lg border border-purple-200">
                            <div class="p-4 border-b border-purple-200 bg-purple-50">
                                <h3 class="text-lg font-semibold text-purple-900 flex items-center">
                                    <i data-lucide="check-circle" class="mr-2 w-5 h-5"></i>
                                    Tamamlanan Görevler
                                </h3>
                            </div>
                            <div class="p-4 space-y-3 max-h-96 overflow-y-auto">
                                ${completedTasks.length > 0 ? completedTasks.map(activity => `
                                    <div class="border-l-4 border-purple-500 pl-4 py-2 bg-purple-50 rounded-r">
                                        <h4 class="font-semibold text-purple-900">${activity.task.title}</h4>
                                        <p class="text-sm text-purple-700">${activity.task.description}</p>
                                        <div class="flex justify-between text-xs text-purple-600 mt-1">
                                            <span>${activity.task.responsible}</span>
                                            <span>${categories[activity.task.category].name}</span>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-purple-500 text-center py-8">Bu hafta tamamlanan görev yok</p>'}
                            </div>
                        </div>

                        <!-- Started Tasks -->
                        <div class="bg-white rounded-lg shadow-lg border border-purple-200">
                            <div class="p-4 border-b border-purple-200 bg-purple-50">
                                <h3 class="text-lg font-semibold text-purple-900 flex items-center">
                                    <i data-lucide="play-circle" class="mr-2 w-5 h-5"></i>
                                    Başlanan Görevler
                                </h3>
                            </div>
                            <div class="p-4 space-y-3 max-h-96 overflow-y-auto">
                                ${startedTasks.length > 0 ? startedTasks.map(activity => `
                                    <div class="border-l-4 border-purple-500 pl-4 py-2 bg-purple-50 rounded-r">
                                        <h4 class="font-semibold text-purple-900">${activity.task.title}</h4>
                                        <p class="text-sm text-purple-700">${activity.task.description}</p>
                                        <div class="flex justify-between text-xs text-purple-600 mt-1">
                                            <span>${activity.task.responsible}</span>
                                            <span>${categories[activity.task.category].name}</span>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-purple-500 text-center py-8">Bu hafta başlanan görev yok</p>'}
                            </div>
                        </div>

                        <!-- Progress Tasks -->
                        <div class="bg-white rounded-lg shadow-lg border border-purple-200">
                            <div class="p-4 border-b border-purple-200 bg-purple-50">
                                <h3 class="text-lg font-semibold text-purple-900 flex items-center">
                                    <i data-lucide="trending-up" class="mr-2 w-5 h-5"></i>
                                    İlerleme Kaydeden
                                </h3>
                            </div>
                            <div class="p-4 space-y-3 max-h-96 overflow-y-auto">
                                ${progressTasks.length > 0 ? progressTasks.map(activity => `
                                    <div class="border-l-4 border-purple-500 pl-4 py-2 bg-purple-50 rounded-r">
                                        <h4 class="font-semibold text-purple-900">${activity.task.title}</h4>
                                        <p class="text-sm text-purple-700">${activity.task.description}</p>
                                        <div class="flex justify-between text-xs text-purple-600 mt-1">
                                            <span>${activity.task.responsible}</span>
                                            <span>${categories[activity.task.category].name}</span>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-purple-500 text-center py-8">Bu hafta ilerleme kaydeden görev yok</p>'}
                            </div>
                        </div>
                    </div>

                    <!-- Export for Presentation -->
                    <div class="bg-white rounded-lg shadow-lg p-6 border border-purple-200">
                        <h3 class="text-lg font-semibold text-purple-900 mb-4">EXCO Sunumu İçin Özet</h3>
                        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                            <h4 class="font-semibold text-purple-900 mb-2">Bu Hafta Kırgızistan Projesi İlerlemesi:</h4>
                            <ul class="space-y-1 text-sm text-purple-800">
                                <li>• <span class="font-medium">${completedTasks.length} görev tamamlandı</span></li>
                                <li>• <span class="font-medium">${startedTasks.length} yeni görev başlatıldı</span></li>
                                <li>• <span class="font-medium">${progressTasks.length} görevde ilerleme kaydedildi</span></li>
                                <li>• Toplam aktif görev sayısı: <span class="font-medium">${tasks.filter(t => t.status !== 'done').length}</span></li>
                            </ul>
                        </div>
                        <button onclick="copyToClipboard()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i data-lucide="copy" class="inline mr-2 w-4 h-4"></i>
                            Panoya Kopyala
                        </button>
                    </div>
                </div>
            `;
        }

        // YARDIMCI FONKSİYONLAR
        function getTaskPosition(task, startDate, endDate) {
            if (!task.startDate || !task.endDate) {
                return { left: '0%', width: '10%' };
            }
            
            const taskStart = new Date(task.startDate);
            const taskEnd = new Date(task.endDate);
            const totalDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
            const startOffset = (taskStart - startDate) / (1000 * 60 * 60 * 24);
            const duration = (taskEnd - taskStart) / (1000 * 60 * 60 * 24);
            
            return {
                left: `${Math.max(0, (startOffset / totalDays) * 100)}%`,
                width: `${Math.max(5, (duration / totalDays) * 100)}%`
            };
        }

        function getThisWeekActivities() {
            const activities = [];
            
            // Tamamlanan görevler (done status olanlar)
            tasks.filter(task => task.status === 'done').slice(0, 3).forEach(task => {
                activities.push({
                    type: 'completed',
                    task: task,
                    date: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000)
                });
            });

            // Bu hafta başlayan görevler (ongoing status olanlar)
            tasks.filter(task => task.status === 'ongoing').slice(0, 2).forEach(task => {
                activities.push({
                    type: 'started',
                    task: task,
                    date: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000)
                });
            });

            // İlerleme kaydeden görevler
            tasks.filter(task => task.status === 'ongoing' && task.progress > 0).forEach(task => {
                activities.push({
                    type: 'progress',
                    task: task,
                    date: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000)
                });
            });

            return activities.sort((a, b) => b.date - a.date);
        }

        // ROADMAP ETKİLEŞİMLERİ
        function initializeRoadmapEvents() {
            // Drag and drop
            document.querySelectorAll('.task-card[draggable="true"]').forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    const taskId = parseInt(e.currentTarget.dataset.taskId);
                    draggedTask = tasks.find(task => task.id === taskId);
                    e.currentTarget.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', (e) => {
                    e.currentTarget.classList.remove('dragging');
                    draggedTask = null;
                });
            });

            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    zone.classList.add('drag-over');
                });

                zone.addEventListener('dragleave', (e) => {
                    zone.classList.remove('drag-over');
                });

                zone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    
                    if (draggedTask) {
                        const newTimePhase = zone.dataset.phase;
                        if (draggedTask.timePhase !== newTimePhase) {
                            try {
                                await TaskAPI.updateTaskTimePhase(draggedTask.id, newTimePhase);
                                // Real-time subscription otomatik güncelleyecek
                            } catch (error) {
                                console.error('Zaman dilimi güncellenirken hata:', error);
                            }
                        }
                    }
                });
            });

            // Status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const taskId = parseInt(btn.dataset.taskId);
                    const newStatus = btn.dataset.status;
                    
                    try {
                        await TaskAPI.updateTaskStatus(taskId, newStatus);
                        // Real-time subscription otomatik güncelleyecek
                    } catch (error) {
                        console.error('Durum güncellenirken hata:', error);
                    }
                });
            });

            // Edit buttons
            document.querySelectorAll('.edit-task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = parseInt(btn.dataset.taskId);
                    const task = tasks.find(t => t.id === taskId);
                    openTaskModal(task);
                });
            });
        }

        // GLOBAL FONKSİYONLAR
        function copyToClipboard() {
            const thisWeekActivities = getThisWeekActivities();
            const completedTasks = thisWeekActivities.filter(activity => activity.type === 'completed');
            const startedTasks = thisWeekActivities.filter(activity => activity.type === 'started');
            const progressTasks = thisWeekActivities.filter(activity => activity.type === 'progress');
            
            const text = `Kırgızistan Projesi - Bu Hafta İlerlemesi:

✅ ${completedTasks.length} görev tamamlandı
🚀 ${startedTasks.length} yeni görev başlatıldı
📈 ${progressTasks.length} görevde ilerleme kaydedildi
📊 Toplam aktif görev sayısı: ${tasks.filter(t => t.status !== 'done').length}`;

            navigator.clipboard.writeText(text).then(() => {
                alert('Metin panoya kopyalandı!');
            }).catch(() => {
                alert('Kopyalama işlemi başarısız. Metni manuel olarak kopyalayın.');
            });
        }
</body>
</html>
